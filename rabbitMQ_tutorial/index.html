<html>
<head>
<title>Socket and Redis in Node.js</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
</head>
<body>
<div id="username">
<input type="text" name="usernameTxt" /> <input type="button" name="setUsername" value="Set Username" />
</div>
<div id="sendChat" style="display:none;">
<input type="text" name="chatTxt" /> <input type="button" name="sendBtn" value="Send" /> <input type="button" name="closeBtn" value="Close" />
</div>
<br />
<div id="content"></div>
<script>
$(document).ready(function() {
  var username = "anonymous";
  $('input[name=setUsername]').click(function(){
    if($('input[name=usernameTxt]').val() != ""){
      username = $('input[name=usernameTxt]').val();
      var msg = {type:'register', userId: username, routingKey : 'rocksea' };
      socket.json.send(msg);
    }
    $('#username').slideUp("slow",function(){
      $('#sendChat').slideDown("slow");
    });
  });
  var socket = new io.connect('http://192.168.0.142:3300');
  var content = $('#content');

  socket.on('connect', function() {
    console.log("Connected");
  });

  socket.on('message', function(message){
    var msg = $.parseJSON(message);
    content.append(msg.userId + " : " + msg.message + '<br />');
  }) ;

  socket.on('disconnect', function() {
    console.log('disconnected');
    content.html("<b>Disconnected!</b>");
  });

  socket.on('connect', function() {
    var msg = {routingKey : 'rocksea' };
    //sub.emit('bindQueue',msg);
  });

  socket.on('data', function(message){
    alert("## message : " + message.message);
  });

  $("input[name=sendBtn]").click(function(){
    var message = $("input[name=chatTxt]").val();
    var msg = {type: 'chat', userId: username, message: message, routingKey : 'rocksea' };
    socket.json.send(msg);
    $("input[name=chatTxt]").val("");
  });

  $("input[name=closeBtn]").click(function(){
    alert('close');
    socket.disconnect();
  });
});
</script>
</body>
</html>
